= Configure diagnostic logging

This section explains how to configure diagnostics for Hazelcast clusters managed by the Hazelcast Platform Operator, including enabling diagnostics, forwarding diagnostics to your logging framework, setting auto turn-off to avoid disk overuse, and persisting diagnostics to a Persistent Volume Claim (PVC).

== Enable diagnostics using the custom resource

The Operator exposes a diagnostics configuration you can set in the Hazelcast custom resource:

* Fields include outputType (STDOUT, LOGGER, FILE), includeEpochTime, maxRolledFileSize, maxRolledFileCount, fileNamePrefix, pluginProperties, autoOffTimerInMinutes, and pvcName. See: https://docs.hazelcast.com/operator/latest-snapshot/api-ref#diagnostics[Diagnostics].
* File-based rolling limits can also be controlled via DiagnosticsFileConfiguration (maxRolledFileSizeInMB, maxRolledFileCount, fileNamePrefix) where applicable. See: https://docs.hazelcast.com/operator/latest-snapshot/api-ref#diagnosticsfileconfiguration[DiagnosticsFileConfiguration].

*Example:*

* outputType: choose the output destination (e.g. FILE or STDOUT). The default is STDOUT in Operator.
* maxRolledFileSize / maxRolledFileCount: cap file size and retention.
* fileNamePrefix: add a custom prefix.
* pluginProperties: pass the same diagnostics system properties shown above (e.g. enable plugins or adjust their periods).
* autoOffTimerInMinutes: configure automatic turn-off (see below).
* pvcName: bind diagnostics to a PVC (see below).

== Forward diagnostics to a logging framework

Instead of file output, you can forward diagnostics to your logging framework by setting `spec.diagnostics.outputType=LOGGER`

Then configure the com.hazelcast.diagnostics logger (e.g. a Log4j2 logger and rolling appender) to control size and rollover using time/size policies. For information, see https://docs.hazelcast.com/hazelcast/latest/maintain-cluster/monitoring#diagnostics-using-logging-frameworks[Diagnostics using Logging Frameworks].

== Dynamic diagnostic logging (turn on/off at runtime)

You can use the Operator to enable/disable and control diagnostic properties and plugins without restarting members. 
// question - so how do you actually enable dynamic logging? What else do we need to tell them here?
// incorrect link - where should we link to? See https://docs.hazelcast.com/hazelcast/latest/maintain-cluster/monitoring#diagnostics-using-logging-frameworks[Diagnostics using Logging Frameworks].
The Operator also provides an auto turn-off feature (see below).

== Auto turn-off

To prevent diagnostic logs from running indefinitely, set the Operator's `autoOffTimerInMinutes` to automatically disable diagnostic logging after the specified number of minutes. See https://docs.hazelcast.com/operator/latest-snapshot/api-ref#diagnostics[Diagnostics].

You can combine this with rolling limits:

* Operator diagnostics: maxRolledFileSize, maxRolledFileCount.
* Hazelcast properties: hazelcast.diagnostics.max.rolled.file.size.mb and hazelcast.diagnostics.max.rolled.file.count.

== Persist diagnostics to a PVC

To retain diagnostics across pod restarts and isolate them from container stdout, mount a Persistent Volume Claim and direct diagnostics there:

* Set the diagnostics output to files and point the directory to a mounted path using hazelcast.diagnostics.directory.
* In the Operator, specify `pvcName` in the diagnostics config to mount a PVC for diagnostics. This instructs the Operator to use the named PVC for diagnostics storage (the detailed mounting YAML is not included in the sources).

NOTE: System log diagnostics (cluster activity and optional partition migration details) can be enabled/tuned via `hazelcast.diagnostics.systemlog.enabled` and `hazelcast.diagnostics.systemlog.partitions` if needed. See https://docs.hazelcast.com/hazelcast/latest/maintain-cluster/monitoring#systemlog[SystemLog].

== Enable diagnostics via system properties

// question - is this a better place for this section?

Diagnostics are also controlled via system properties and can be enabled with rolling log controls and output destination. Set at least the following properties on members:

* Enable diagnostics and set plugin intervals/levels:
** hazelcast.diagnostics.metric.level=info
** hazelcast.diagnostics.invocation.sample.period.seconds=30
** hazelcast.diagnostics.pending.invocations.period.seconds=30
** hazelcast.diagnostics.slowoperations.period.seconds=30
** hazelcast.diagnostics.storeLatency.period.seconds=60

For more information, see https://docs.hazelcast.com/hazelcast/latest/maintain-cluster/monitoring#diagnostics[Diagnostics]. 

// question - is the following in the right place or should this appear higher up e.g. in "Enable diagnostics using the custom resource"? Please advise

The diagnostics file rolls by default (10 files, 50 MB each) and contains plugin sections such as BuildInfo, SystemProperties, ConfigProperties, Metrics, SlowOperations, and HazelcastInstance. For information, see https://docs.hazelcast.com/hazelcast/latest/maintain-cluster/monitoring#diagnostics-plugins[Diagnostics Plugins].
